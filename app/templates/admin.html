<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç®¡ç†é¢æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body { 
            background-color: #f4f5f9;
            background-image: linear-gradient(135deg, #f4f5f9 0%, #e0e3ec 100%);
            min-height: 100vh;
        }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .tab { padding: 0.75rem 1.5rem; font-weight: 500; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; transition: all .2s ease; cursor: pointer; border-bottom: 2px solid #d1d5db; background: #f3f4f6; color: #4b5563; }
        .tab-active { background: #ffffff; color: #660874; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); border-bottom-color: #ffffff; }
        .tab-inactive { background: #f3f4f6; color: #4b5563; border-bottom-color: #d1d5db; }
        .tab-inactive:hover { background: #e5e7eb; }
        .tsinghua-purple { color: #660874; }
        .tsinghua-purple-bg { background-color: #660874; }
        .form-checkbox { @apply h-5 w-5 text-purple-600 rounded-md border-gray-300 focus:ring-purple-500; }
  </style>
</head>
<body class="text-gray-800 py-6">
    <div class="max-w-7xl mx-auto px-6">
        <!-- Header -->
            <div class="bg-white rounded-2xl p-6 card mb-6">
            <div class="flex items-center justify-between">
      <div>
                    <h1 class="text-3xl font-bold tsinghua-purple">
                        {{ course_name }} ç®¡ç†é¢æ¿
                    </h1>
      </div>
                <div class="flex items-center gap-3">
                    <a href="/" class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all text-sm font-medium">
                        è¿”å›é¦–é¡µ
        </a>
      </div>
    </div>
    </div>

        <!-- Tabs (sticky) -->
        <div class="flex gap-2 mb-6 sticky top-0 z-20 bg-gradient-to-b from-white/90 to-transparent pt-3">
            <button id="tab-scores" class="tab tab-active">ğŸ“Š è¯„åˆ†æ•°æ®</button>
            <button id="tab-presentation" class="tab tab-inactive">ğŸ‘¥ å°ç»„ä¸é¡ºåº</button>
            <button id="tab-sessions" class="tab tab-inactive">ğŸ• åœºæ¬¡ç®¡ç†</button>
            <button id="tab-system" class="tab tab-inactive">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
      </div>

        <!-- View: Scores -->
        <div id="view-scores" class="space-y-6">
            <!-- æäº¤è¿›åº¦å¡ç‰‡ -->
            <div class="bg-white rounded-2xl p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ“Š æäº¤è¿›åº¦</h2>
                    <button onclick="refreshProgress()" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all text-sm font-medium">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-3xl font-bold tsinghua-purple" id="progress-total">-</div>
                        <div class="text-sm text-gray-600 mt-1">æ€»ç»„æ•°</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-3xl font-bold text-green-600" id="progress-submitted">-</div>
                        <div class="text-sm text-gray-600 mt-1">å·²æäº¤</div>
                    </div>
                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                        <div class="text-3xl font-bold text-orange-600" id="progress-remaining">-</div>
                        <div class="text-sm text-gray-600 mt-1">æœªæäº¤</div>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-3xl font-bold text-blue-600" id="progress-percentage">-</div>
                        <div class="text-sm text-gray-600 mt-1">å®Œæˆåº¦</div>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-500 h-3 rounded-full transition-all duration-500" 
                         style="width: 0%" id="admin-progress-bar"></div>
                </div>
            </div>
            
            <!-- è¯„åˆ†æ ¡å‡†æç¤º -->
            {% if anomalies %}
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-amber-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        å¼‚å¸¸è¯„åˆ†ï¼ˆ{{ anomalies|length }}ï¼‰
                    </h2>
                    <span class="text-xs text-gray-600">è¯·å¤æ ¸</span>
                </div>
                <div class="space-y-2">
                    {% for anomaly in anomalies[:5] %}
                    <div class="bg-white p-3 rounded-lg flex items-center justify-between">
                        <div>
                            <span class="font-bold text-gray-800">{{ anomaly.rater }}</span>
                            <span class="text-gray-600">â†’</span>
                            <span class="font-medium text-gray-700">{{ anomaly.target }}</span>
                            <span class="text-gray-600">æ‰“åˆ†ï¼š</span>
                            <span class="font-bold tsinghua-purple">{{ anomaly.score }}</span>
                        </div>
                        <span class="text-sm text-amber-700 bg-amber-100 px-3 py-1 rounded-full">{{ anomaly.reason }}</span>
                    </div>
                    {% endfor %}
                    {% if anomalies|length > 5 %}
                    <div class="text-center text-sm text-gray-500 mt-2">
                        è¿˜æœ‰ {{ anomalies|length - 5 }} ä¸ªå¼‚å¸¸...
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="bg-white rounded-2xl p-6 card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">å¹³å‡åˆ†</h2>
                    <div class="flex gap-2">
                        <button id="toggle-view" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all text-sm font-medium">
                            ğŸ“Š åˆ‡æ¢ä¸ºå›¾è¡¨è§†å›¾
                        </button>
                        <button id="export-csv" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all text-sm font-medium shadow-lg">
                            å¯¼å‡ºCSV
                        </button>
                    </div>
                </div>
                
                <!-- è¡¨æ ¼è§†å›¾ -->
                <div id="table-view" class="overflow-x-auto">
                    <table class="w-full text-sm">
            <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">å°ç»„</th>
                                <th class="text-center py-3 px-4 font-semibold text-gray-700">å¹³å‡åˆ†</th>
                                <th class="text-center py-3 px-4 font-semibold text-gray-700">è¯„åˆ†äººæ•°</th>
              </tr>
            </thead>
            <tbody>
              {% for avg in averages %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/50 transition-colors">
                                <td class="py-3 px-4 font-medium">{{ avg.target }}</td>
                                <td class="py-3 px-4 text-center">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold
                                        {% if avg.average >= 8.5 %}bg-green-100 text-green-700
                                        {% elif avg.average >= 7 %}bg-blue-100 text-blue-700
                                        {% elif avg.average >= 6 %}bg-yellow-100 text-yellow-700
                                        {% else %}bg-red-100 text-red-700{% endif %}">
                  {{ '%.1f'|format(avg.average) }}
                                    </span>
                </td>
                                <td class="py-3 px-4 text-center text-gray-600">{{ avg.count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- å›¾è¡¨è§†å›¾ï¼ˆè½»é‡å¯è§†åŒ–ï¼‰ -->
        <div id="chart-view" class="hidden space-y-3">
            {% for avg in averages %}
            <div class="flex items-center gap-3">
                <div class="w-16 text-right font-medium text-gray-700">{{ avg.target }}ç»„</div>
                <div class="flex-1 relative h-8 bg-gray-100 rounded-lg overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-700 flex items-center justify-end px-3"
                         style="width: {{ avg.average }}%">
                        <span class="text-white font-bold text-sm">{{ '%.1f'|format(avg.average) }}</span>
                    </div>
                </div>
                <div class="w-12 text-gray-500 text-sm">{{ avg.count }}ç¥¨</div>
            </div>
            {% endfor %}
        </div>
      </div>
            <div class="bg-white rounded-2xl p-6 card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">è¯„åˆ†çŸ©é˜µ</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
            <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-3 font-semibold text-gray-700 sticky left-0 bg-white">è¯„åˆ†è€…</th>
                {% for g in groups %}
                                <th class="text-center py-3 px-3 font-semibold text-gray-700">{{ g }}</th>
                {% endfor %}
                                <th class="text-center py-3 px-3 font-semibold text-gray-700">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for rater, scores in score_matrix.items() %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/30 transition-colors">
                                <td class="py-3 px-3 font-medium sticky left-0 bg-white">{{ rater }}</td>
                {% for target in groups %}
                  {% if target in scores %}
                                    <td class="py-3 px-3 text-center">
                                        <div class="space-y-1">
                                            <div class="font-bold tsinghua-purple">{{ '%.1f'|format(scores[target].total) }}</div>
                                            <button onclick="deleteScore('{{ rater }}', '{{ target }}')" 
                                                    class="text-xs text-red-500 hover:text-red-700 hover:underline">åˆ é™¤</button>
                      </div>
                    </td>
                  {% else %}
                                    <td class="py-3 px-3 text-center text-gray-400">-</td>
                  {% endif %}
                {% endfor %}
                                <td class="py-3 px-3 text-center">
                                    <div class="flex flex-col gap-1">
                                        <div class="flex gap-1">
                                            <button onclick="toggleLock('{{ rater }}', this)" 
                                                    class="px-2 py-1 bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200 transition-all text-xs font-medium lock-toggle"
                                                    data-rater="{{ rater }}">
                                                åˆ‡æ¢é”å®š
                                            </button>
                                            <button onclick="unlockAndEdit('{{ rater }}', true)" 
                                                    class="px-2 py-1 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition-all text-xs font-medium">
                                                ç¼–è¾‘
                                            </button>
                                        </div>
                                        <button onclick="resetRater('{{ rater }}')" 
                                                class="px-2 py-1 bg-red-100 text-red-800 rounded-lg hover:bg-red-200 transition-all text-xs font-medium">
                                            é‡ç½®
                                        </button>
                                    </div>
                                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

        <div id="view-presentation" class="hidden bg-white rounded-2xl p-6 card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">å°ç»„ä¸é¡ºåº</h2>
                <div class="flex items-center gap-2">
                    <input id="new-group-name" type="text" placeholder="æ–°å°ç»„åç§°" 
                           class="border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    <label class="ml-2 text-sm text-gray-700 flex items-center gap-1">
                        <input id="new-group-scorable" type="checkbox" class="form-checkbox" checked>
                        å¯è¢«è¯„åˆ†
                    </label>
                    <button onclick="addGroup(document.getElementById('new-group-scorable').checked)" class="px-4 py-2 tsinghua-purple-bg text-white rounded-lg hover:opacity-90 transition-all text-sm font-medium">
                        + æ·»åŠ å°ç»„
                    </button>
        </div>
      </div>

            <p class="text-sm text-gray-600 mb-4">æ‹–æ‹½è°ƒæ•´é¡ºåºï¼›å¤é€‰æ¡†åˆ‡æ¢ã€Œå¯è¢«è¯„åˆ†ã€ã€‚</p>
            <ul id="presentation-list" class="space-y-2"></ul>
            
            <div class="mt-6 pt-6 border-t border-gray-200 flex justify-between items-center">
                <div class="flex-1">
                    <h3 class="font-semibold mb-3 text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-2 tsinghua-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
                        å½“å‰é¡ºåºé¢„è§ˆ
                    </h3>
                    <div id="current-order" class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 p-4 rounded-xl text-gray-700 font-medium text-center shadow-inner">
                        å°šæœªè®¾ç½®
                    </div>
      </div>
                <div class="flex gap-2">
                    <button id="randomize-order" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all text-sm font-medium">
                        ğŸ² éšæœºæ’åºå°ç»„
                    </button>
                    <button id="save-order" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all text-sm font-medium">
                        ğŸ’¾ ä¿å­˜å°ç»„é¡ºåº
                    </button>
        </div>
      </div>
    </div>

        <div id="view-sessions" class="hidden bg-white rounded-2xl p-6 card">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">åœºæ¬¡ç®¡ç†</h2>
                <div class="flex items-center gap-2">
                    <input id="new-session-name" type="text" placeholder="ä¾‹å¦‚ï¼š2025-æ˜¥ ç¬¬1æ¬¡" 
                           class="border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    <button id="create-session" class="px-4 py-2 tsinghua-purple-bg text-white rounded-lg hover:opacity-90 transition-all text-sm font-medium">
                        + æ–°å»ºåœºæ¬¡
                    </button>
                </div>
        </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
            <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">åœºæ¬¡åç§°</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">åˆ›å»ºæ—¶é—´</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700">çŠ¶æ€</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
                        {% for s in sessions %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50/50 transition-colors">
                            <td class="py-3 px-4 font-medium">{{ s.name }}</td>
                            <td class="py-3 px-4 text-gray-600">{{ s.created_at }}</td>
                            <td class="py-3 px-4 text-center">
                                {% if s.active %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">
                                    âœ“ å½“å‰åœºæ¬¡
                                </span>
                  {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                    å†å²
                                </span>
                  {% endif %}
                </td>
                            <td class="py-3 px-4 text-center">
                                {% if not s.active %}
                                <div class="flex gap-1 justify-center">
                                    <button onclick="activateSession({{ s.id }})" 
                                            class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-all text-xs font-medium">
                                        è®¾ä¸ºå½“å‰
                                    </button>
                                    <button onclick="deleteSession({{ s.id }})" 
                                            class="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-all text-xs font-medium">
                                        åˆ é™¤
                                    </button>
                                </div>
                  {% else %}
                                <span class="text-xs text-gray-400">å½“å‰åœºæ¬¡</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

        <div id="view-system" class="hidden bg-white rounded-2xl p-6 card">
            <h2 class="text-xl font-bold text-gray-800 mb-6">ç³»ç»Ÿè®¾ç½®</h2>

            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">è¯¾ç¨‹åç§°</label>
                        <input type="text" value="{{ course_name }}" disabled 
                               class="w-full border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">ä¿®æ”¹ config.py ä¸­çš„ COURSE_NAME</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">æ•™å­¦æœºæ„</label>
                        <input type="text" value="{{ course_institution }}" disabled 
                               class="w-full border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">ä¿®æ”¹ config.py ä¸­çš„ COURSE_INSTITUTION</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ç®¡ç†å‘˜ç™»å½•</label>
                        <input type="text" value="å·²ç™»å½•" disabled 
                               class="w-full border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">ç®¡ç†å‘˜æƒé™åŸºäºæµè§ˆå™¨ä¼šè¯ï¼Œæ— éœ€åœ¨é¡µé¢æš´éœ²å¯†é’¥</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">é”è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" value="{{ lock_expiry_minutes }}" disabled 
                               class="w-full border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">ä¿®æ”¹ config.py ä¸­çš„ LOCK_EXPIRY_MINUTES</p>
                    </div>
                </div>

                <div class="pt-6 border-t border-gray-200">
                    <button id="reset-system" 
                            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all font-medium shadow-lg">
                        ğŸ—‘ï¸ é‡ç½®ç³»ç»Ÿï¼ˆå±é™©æ“ä½œï¼‰
                    </button>
                    <p class="text-xs text-gray-500 mt-2">é‡ç½®å°†æ¸…é™¤å½“å‰åœºæ¬¡çš„æ‰€æœ‰è¯„åˆ†æ•°æ®ã€é”çŠ¶æ€å’Œå‘è¡¨é¡ºåº</p>
          </div>
      </div>
    </div>
  </div>

  <script>
        // ç®¡ç†æ“ä½œä¾èµ–ç®¡ç†å‘˜ä¼šè¯ Cookieï¼Œä¸åœ¨é¡µé¢ä¸­æš´éœ²å¯†é’¥
        
        // Toggle between table and chart view
        document.getElementById('toggle-view').addEventListener('click', function() {
            const tableView = document.getElementById('table-view');
            const chartView = document.getElementById('chart-view');
            const button = this;
            
            if (tableView.classList.contains('hidden')) {
                // åˆ‡æ¢ä¸ºè¡¨æ ¼è§†å›¾
                tableView.classList.remove('hidden');
                chartView.classList.add('hidden');
                button.textContent = 'ğŸ“Š åˆ‡æ¢ä¸ºå›¾è¡¨è§†å›¾';
            } else {
                // åˆ‡æ¢ä¸ºå›¾è¡¨è§†å›¾
                tableView.classList.add('hidden');
                chartView.classList.remove('hidden');
                button.textContent = 'ğŸ“‹ åˆ‡æ¢ä¸ºè¡¨æ ¼è§†å›¾';
            }
        });
        
        // Tab switching
        const tabs = ['scores', 'presentation', 'sessions', 'system'];
        tabs.forEach(tab => {
            document.getElementById('tab-' + tab).addEventListener('click', () => {
                tabs.forEach(t => {
                    document.getElementById('tab-' + t).classList.remove('tab-active');
                    document.getElementById('tab-' + t).classList.add('tab-inactive');
                    const view = document.getElementById('view-' + t);
                    if(view) view.classList.add('hidden');
                });
                document.getElementById('tab-' + tab).classList.remove('tab-inactive');
                document.getElementById('tab-' + tab).classList.add('tab-active');
                const view = document.getElementById('view-' + tab);
                if(view) view.classList.remove('hidden');
                
                if (tab === 'presentation') loadGroupsForPresentation();
            });
        });

        // Export CSV
    document.getElementById('export-csv').addEventListener('click', () => {
            let csv = "è¯„åˆ†ç»„,è¢«è¯„ç»„,æ€»åˆ†\n";
      {% for rater, scores in score_matrix.items() %}
        {% for target, score in scores.items() %}
                    csv += `{{ rater }},{{ target }},{{ score.total }}\n`;
        {% endfor %}
      {% endfor %}
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
            link.href = url;
            link.download = "è¯„åˆ†æ•°æ®_" + new Date().toISOString().slice(0,10) + ".csv";
      link.click();
        });

        // Build locked set from server (based on submissions)
        const LOCKED = new Set([
            {% for r in locked_raters %}'{{ r }}',{% endfor %}
        ]);

        // Initialize lock button labels
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.lock-toggle').forEach(btn => {
                const r = btn.dataset.rater;
                btn.textContent = LOCKED.has(r) ? 'è§£é”' : 'å·²è§£é”';
                btn.disabled = !LOCKED.has(r);
                if (!LOCKED.has(r)) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:bg-amber-200');
                }
            });
        });

        // Lock toggle (only unlock is available - lock happens on submit)
        function toggleLock(rater, el) {
            const isLocked = LOCKED.has(rater);
            if (!isLocked) return; // Already unlocked, do nothing
            
            if (!confirm(`ç¡®å®šè¦è§£é”ã€Œ${rater}ã€å—ï¼Ÿè§£é”åè¯¥ç»„å¯é‡æ–°æäº¤è¯„åˆ†ã€‚`)) return;
            
            fetch(`/release-lock/${encodeURIComponent(rater)}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        LOCKED.delete(rater);
                        el.textContent = 'å·²è§£é”';
                        el.disabled = true;
                        el.classList.add('opacity-50', 'cursor-not-allowed');
                        el.classList.remove('hover:bg-amber-200');
                        alert(`ã€Œ${rater}ã€å·²è§£é”ï¼Œè¯¥ç»„å¯ä»é¦–é¡µé‡æ–°æäº¤è¯„åˆ†ã€‚`);
                        location.reload();
                    } else {
                        alert('è§£é”å¤±è´¥');
                    }
                });
        }

        // Edit (direct admin edit with prefill)
        function unlockAndEdit(rater, edit) {
            if (edit) {
                window.location.href = `/start?rater=${encodeURIComponent(rater)}`;
            }
        }

        // Reset rater (delete all their scores and unlock)
        function resetRater(rater) {
            if (!confirm(`ç¡®å®šè¦é‡ç½®ã€Œ${rater}ã€çš„æ‰€æœ‰è¯„åˆ†å—ï¼Ÿè¿™å°†åˆ é™¤è¯¥ç»„æäº¤çš„æ‰€æœ‰åˆ†æ•°å¹¶è§£é”ã€‚`)) return;
            
            fetch(`/admin/reset-rater/${encodeURIComponent(rater)}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        alert(`ã€Œ${rater}ã€å·²é‡ç½®`);
                        location.reload();
                    } else {
                        alert('é‡ç½®å¤±è´¥');
                    }
                });
        }

        // Delete score
    function deleteScore(rater, target) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${rater} å¯¹ ${target} çš„è¯„åˆ†å—ï¼Ÿ`)) {
        const formData = new FormData();
        formData.append('rater', rater);
        formData.append('target', target);
        fetch('/delete-score', { method: 'POST', body: formData })
                    .then(r => r.json())
        .then(data => {
                        if (data.ok) { location.reload(); } else { alert('åˆ é™¤å¤±è´¥'); }
        });
      }
    }

        // Group management and Presentation Order (Combined)
        function loadGroupsForPresentation() {
            fetch(`/admin/groups`)
                .then(r => r.json())
                .then(groups => {
                    const list = document.getElementById('presentation-list');
                    const presentationOrder = {{ presentation_order|tojson }};
                    
                    const orderedGroups = presentationOrder.map(name => groups.find(g => g.name === name)).filter(Boolean);
                    const remainingGroups = groups.filter(g => !presentationOrder.includes(g.name));
                    const allGroups = [...orderedGroups, ...remainingGroups];

                    list.innerHTML = allGroups.map(g => `
                        <li class="p-4 bg-gray-50 border border-gray-200 rounded-lg flex justify-between items-center cursor-move hover:shadow-md transition-all" 
                            data-group="${g.name}" draggable="true">
                            <div class="flex items-center">
                                <span class="font-medium text-gray-800">${g.name}</span>
                                <label class="ml-4 flex items-center text-xs text-gray-600">
                                    <input type="checkbox" ${g.scorable ? 'checked' : ''} onchange="toggleScorable('${g.name}', this.checked)" class="mr-1 form-checkbox">
                                    å¯è¢«è¯„åˆ†
                                </label>
                            </div>
                            <div>
                                <button onclick="deleteGroup('${g.name}')" class="px-2 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-all text-xs font-medium">åˆ é™¤</button>
                                <svg class="inline-block w-5 h-5 text-gray-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </div>
                        </li>
                    `).join('');
                    updateCurrentOrder();
                });
        }


        function addGroup(scorable) {
            const name = document.getElementById('new-group-name').value.trim();
            if (!name) { alert('è¯·è¾“å…¥ç»„åˆ«åç§°'); return; }
            
            fetch(`/admin/groups/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, scorable })
            })
            .then(r => r.json())
        .then(data => {
          if (data.ok) {
                    document.getElementById('new-group-name').value = '';
                    loadGroupsForPresentation();
          } else {
                    alert(data.error || 'æ·»åŠ å¤±è´¥');
          }
        });
      }

        function toggleScorable(name, scorable) {
            fetch(`/admin/groups/toggle-scorable`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, scorable })
            })
            .then(r => r.json())
            .then(data => { if (!data.ok) alert('æ›´æ–°å¤±è´¥'); });
        }

        function deleteGroup(name) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ç»„åˆ« ${name} å—ï¼Ÿ`)) {
                fetch(`/admin/groups/delete?name=${encodeURIComponent(name)}`, { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) { loadGroupsForPresentation(); } else { alert('åˆ é™¤å¤±è´¥'); }
                    });
            }
        }

        // Drag & drop
    const list = document.getElementById('presentation-list');
    let draggedItem = null;

    list.addEventListener('dragstart', (e) => {
      draggedItem = e.target.closest('li');
            if (draggedItem) draggedItem.style.opacity = '0.5';
    });

    list.addEventListener('dragend', (e) => {
      if (draggedItem) {
        draggedItem.style.opacity = '1';
        draggedItem = null;
        updateCurrentOrder();
      }
    });

    list.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (!draggedItem) return;
      const afterElement = getDragAfterElement(list, e.clientY);
      if (afterElement == null) {
        list.appendChild(draggedItem);
      } else {
        list.insertBefore(draggedItem, afterElement);
      }
    });

    function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('li:not([style*="opacity: 0.5"])')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

        function updateCurrentOrder() {
            const items = Array.from(list.children);
            const order = items
                .filter(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    return checkbox && checkbox.checked;
                })
                .map(item => item.dataset.group);
            document.getElementById('current-order').textContent = order.join(' â†’ ') || 'å°šæœªè®¾ç½®';
        }

        document.getElementById('randomize-order').addEventListener('click', () => {
            const items = Array.from(list.children);
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                list.appendChild(items[j]);
            }
            updateCurrentOrder();
        });

        document.getElementById('save-order').addEventListener('click', () => {
            const items = Array.from(list.children);
            const order = items.map(item => item.dataset.group);
            fetch(`/save-presentation-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) { alert('å‘è¡¨é¡ºåºå·²ä¿å­˜'); } else { alert('ä¿å­˜å¤±è´¥'); }
            });
        });

        // Session management
        function activateSession(id) {
            fetch(`/admin/session/activate?session_id=${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) { location.reload(); } else { alert('åˆ‡æ¢å¤±è´¥'); }
                });
        }

        function deleteSession(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœºæ¬¡å—ï¼Ÿè¿™å°†åˆ é™¤è¯¥åœºæ¬¡çš„æ‰€æœ‰è¯„åˆ†æ•°æ®ï¼')) return;
            fetch(`/admin/session/delete?session_id=${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) { 
                        alert('åœºæ¬¡å·²åˆ é™¤'); 
                        location.reload(); 
                    } else { 
                        alert(data.error || 'åˆ é™¤å¤±è´¥'); 
                    }
                });
        }

        document.getElementById('create-session').addEventListener('click', () => {
            const name = document.getElementById('new-session-name').value.trim();
            if (!name) { alert('è¯·è¾“å…¥åœºæ¬¡åç§°'); return; }
            
            fetch(`/admin/session/create?name=${encodeURIComponent(name)}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) { activateSession(data.id); } else { alert('åˆ›å»ºå¤±è´¥'); }
                });
        });

        // System reset
        document.getElementById('reset-system').addEventListener('click', () => {
            if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®å½“å‰åœºæ¬¡å—ï¼Ÿè¿™å°†æ¸…é™¤è¯¥åœºæ¬¡çš„æ‰€æœ‰è¯„åˆ†æ•°æ®ã€é”çŠ¶æ€å’Œå‘è¡¨é¡ºåºï¼æ­¤æ“ä½œä¸å¯é€†ï¼')) {
                fetch(`/admin/reset`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) {
                            alert('å½“å‰åœºæ¬¡å·²é‡ç½®');
                            location.reload();
                        } else {
                            alert('é‡ç½®å¤±è´¥');
                        }
                    });
            }
        });

        // è·å–å¹¶æ›´æ–°æäº¤è¿›åº¦
        async function refreshProgress() {
            try {
                const response = await fetch('/api/progress');
                const data = await response.json();
                
                document.getElementById('progress-total').textContent = data.total;
                document.getElementById('progress-submitted').textContent = data.submitted;
                document.getElementById('progress-remaining').textContent = data.remaining;
                document.getElementById('progress-percentage').textContent = data.progress + '%';
                
                const progressBar = document.getElementById('admin-progress-bar');
                progressBar.style.width = data.progress + '%';
                
                // å¦‚æœå…¨éƒ¨å®Œæˆï¼Œæ”¹å˜é¢œè‰²
                if (data.progress === 100) {
                    progressBar.classList.remove('from-purple-500', 'to-indigo-500');
                    progressBar.classList.add('from-green-500', 'to-emerald-500');
                } else {
                    progressBar.classList.remove('from-green-500', 'to-emerald-500');
                    progressBar.classList.add('from-purple-500', 'to-indigo-500');
                }
            } catch (error) {
                console.error('è·å–è¿›åº¦å¤±è´¥:', error);
            }
        }

        // Init
        loadGroupsForPresentation();
        refreshProgress();  // åˆå§‹åŠ è½½è¿›åº¦
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°è¿›åº¦
        setInterval(refreshProgress, 30000);
  </script>
  <footer class="text-center text-sm text-gray-600 mt-8 pt-4 border-t border-gray-200">
      <p>Â© 2025 {% if course_institution %}{{ course_institution }}{% endif %}{{ course_name }}è¯¾ç¨‹ç»„</p>
      <p class="text-xs text-gray-400 mt-1">
          Built with 
          <a href="https://github.com/baksili" target="_blank" rel="noopener" class="hover:text-gray-600 transition-colors" title="Built by an open-source developer">ğŸ’œ</a> 
          and 
          <a href="/" class="text-gray-400 hover:text-gray-600 transition-colors" title="è¿”å›é¦–é¡µ">âš™ï¸</a>
      </p>
  </footer>
</body>
</html>